<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>DIF 2026 Yearly Wheel</title>
  <style>
    body { font-family: sans-serif; }

    #timeline { width: 600px; height: 600px; margin: auto; }

    #legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<div id="legend"></div>
<div id="timeline"></div>

<script type="module">
import CircularTimeline from 'https://unpkg.com/circalify@latest/src/index.js';
import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';

const YEAR = 2026;

async function loadCSV(url) {
  const response = await fetch(url);
  const text = await response.text();
  return Papa.parse(text, { header: true }).data;
}

const rawEvents = await loadCSV(
  'https://docs.google.com/spreadsheets/d/1ad2DsSE9ZqvgaHzglGBkivileGTSi12WTm-cRzlBE0c/export?format=csv'
);

const events = rawEvents
  .filter(e => e.ring)
  .map(e => ({
    ...e,
    startDate: new Date(e.startDate),
    endDate: new Date(e.endDate)
  }));

const timeline = new CircularTimeline('#timeline', {
  startYear: YEAR,
  startMonth: 0,
  numberOfMonths: 12,
  rings: [
    { type: 'calendar' },
    { type: 'data', name: 'Annet', color: '#cda2de' },
    { type: 'data', name: 'Kamper', color: '#0078D4' },
    { type: 'data', name: 'Cuper', color: '#edbd4c' }
  ]
});

timeline.setData(events.filter(e => e.ring === 'Cuper'), 'Cuper');
timeline.setData(events.filter(e => e.ring === 'Kamper'), 'Kamper');
timeline.setData(events.filter(e => e.ring === 'Annet'), 'Annet');

/* ===============================
   NOW INDICATOR (FINAL, CORRECT)
   =============================== */

function addOrUpdateNowIndicator() {
  const svg = document.querySelector('#timeline svg');
  if (!svg) return;

  const now = new Date();
  if (now.getFullYear() !== YEAR) return;

  const vb = svg.viewBox.baseVal;
  const cx = vb.x + vb.width / 2;
  const cy = vb.y + vb.height / 2;
  const radius = Math.min(vb.width, vb.height) / 2;

  const outerRadius = radius - 10;
  const startRadius = outerRadius - 18;

  const month = now.getMonth();
  const daysInMonth = new Date(YEAR, month + 1, 0).getDate();
  const dayProgress = (now.getDate() - 1) / daysInMonth;

  // ðŸ”‘ FINAL CORRECT ANGLE
  const angle = -(month + dayProgress) * (360 / 12);

  svg.querySelectorAll('.now-indicator').forEach(e => e.remove());

  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.classList.add('now-indicator');
  line.setAttribute('x1', cx);
  line.setAttribute('y1', cy - startRadius);
  line.setAttribute('x2', cx);
  line.setAttribute('y2', cy - outerRadius);
  line.setAttribute('stroke', '#e53935');
  line.setAttribute('stroke-width', '2');
  line.setAttribute('transform', `rotate(${angle} ${cx} ${cy})`);

  const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  dot.classList.add('now-indicator');
  dot.setAttribute('cx', cx);
  dot.setAttribute('cy', cy - outerRadius);
  dot.setAttribute('r', 5);
  dot.setAttribute('fill', '#e53935');
  dot.style.filter = 'drop-shadow(0 0 6px #e53935)';
  dot.setAttribute('transform', `rotate(${angle} ${cx} ${cy})`);

  svg.appendChild(line);
  svg.appendChild(dot);

  setTimeout(addOrUpdateNowIndicator, 60_000);
}

requestAnimationFrame(addOrUpdateNowIndicator);
</script>

</body>
</html>

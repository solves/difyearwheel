<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>DIF 2026 Yearly Wheel with Now Indicator</title>
  <style>
    body { font-family: sans-serif; }

    #timeline { width: 600px; height: 600px; margin: auto; }

    #legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    #tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.1s;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="legend"></div>
<div id="timeline"></div>
<div id="tooltip"></div>

<script type="module">
import CircularTimeline from 'https://unpkg.com/circalify@latest/src/index.js';
import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';

const YEAR = 2026;

// --- Load CSV events ---
async function loadCSV(url) {
  const response = await fetch(url);
  const text = await response.text();
  return Papa.parse(text, { header: true }).data;
}

const rawEvents = await loadCSV(
  'https://docs.google.com/spreadsheets/d/1ad2DsSE9ZqvgaHzglGBkivileGTSi12WTm-cRzlBE0c/export?format=csv'
);

const events = rawEvents
  .filter(e => e.ring)
  .map(e => ({
    ...e,
    startDate: new Date(e.startDate),
    endDate: new Date(e.endDate)
  }));

// --- Create timeline ---
const timeline = new CircularTimeline('#timeline', {
  startYear: YEAR,
  startMonth: 0,
  numberOfMonths: 12,
  rings: [
    { type: 'calendar' },
    { type: 'data', name: 'Annet', color: '#cda2de' },
    { type: 'data', name: 'Kamper', color: '#0078D4' },
    { type: 'data', name: 'Cuper', color: '#edbd4c' },
    { type: 'data', name: 'Now', color: '#e53935' } // NEW ring for "Now"
  ]
});

// --- Add CSV events ---
timeline.setData(
  events.filter(e => e.ring === 'Cuper').map(e => ({ ...e, _label: e.title })),
  'Cuper'
);
timeline.setData(
  events.filter(e => e.ring === 'Kamper').map(e => ({ ...e, _label: e.title })),
  'Kamper'
);
timeline.setData(
  events.filter(e => e.ring === 'Annet').map(e => ({ ...e, _label: e.title })),
  'Annet'
);

// --- Tooltip ---
const tooltip = document.getElementById('tooltip');
requestAnimationFrame(() => {
  document.querySelectorAll('#timeline svg path').forEach(path => {
    const label = path.__data__?._label;
    if (!label) return;
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
    title.textContent = label;
    path.appendChild(title);

    path.addEventListener('mouseenter', () => {
      tooltip.textContent = label;
      tooltip.style.opacity = 1;
    });
    path.addEventListener('mousemove', e => {
      tooltip.style.left = e.clientX + 10 + 'px';
      tooltip.style.top = e.clientY + 10 + 'px';
    });
    path.addEventListener('mouseleave', () => {
      tooltip.style.opacity = 0;
    });
  });
});

// --- Legend ---
const legend = document.getElementById('legend');
[
  { name: 'Kamper', color: '#0078D4' },
  { name: 'Cuper', color: '#edbd4c' },
  { name: 'Annet', color: '#cda2de' },
  { name: 'Now', color: '#e53935' } // include "Now" in legend
].forEach(ring => {
  const item = document.createElement('div');
  item.className = 'legend-item';

  const color = document.createElement('div');
  color.className = 'legend-color';
  color.style.background = ring.color;

  const label = document.createElement('span');
  label.textContent = ring.name;

  item.appendChild(color);
  item.appendChild(label);
  legend.appendChild(item);
});

// --- Now indicator as a moving event ---
function updateNowEvent() {
  const now = new Date();
  const nowEvent = {
    startDate: now,
    endDate: now,
    _label: 'Now',
    color: '#e53935'
  };

  timeline.setData([nowEvent], 'Now'); // Circalify places it correctly

  // Update every minute
  setTimeout(updateNowEvent, 60_000);
}

updateNowEvent();
</script>

</body>
</html>

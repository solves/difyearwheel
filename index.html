<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>DIF 2017 Yearly Wheel</title>
  <style>
    body { font-family: sans-serif; }

    #timeline { width: 600px; height: 600px; margin: auto; }

    #legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* Tooltip */
    #tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.1s;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="legend"></div>
<div id="timeline"></div>
<div id="tooltip"></div>

<script type="module">
  import CircularTimeline from 'https://unpkg.com/circalify@latest/src/index.js';
  import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';

  // --- Load CSV ---
  async function loadCSV(url) {
    const response = await fetch(url);
    const text = await response.text();
    return Papa.parse(text, { header: true }).data;
  }

  const rawEvents = await loadCSV(
    'https://docs.google.com/spreadsheets/d/1ad2DsSE9ZqvgaHzglGBkivileGTSi12WTm-cRzlBE0c/export?format=csv'
  );

  const events = rawEvents
    .filter(e => e.ring)
    .map(e => ({
      ...e,
      startDate: new Date(e.startDate),
      endDate: new Date(e.endDate)
    }));

  // --- Timeline ---
  const timeline = new CircularTimeline('#timeline', {
    startYear: 2026,
    startMonth: 0,
    numberOfMonths: 12,
    rings: [
      { type: 'calendar' },
      { type: 'data', name: 'Annet', color: '#cda2de' },
      { type: 'data', name: 'Kamper', color: '#0078D4' },
      { type: 'data', name: 'Cuper', color: '#edbd4c' }
    ]
  });

  // Attach _label to each event for tooltip
  timeline.setData(
    events.filter(e => e.ring === 'Cuper').map(e => ({ ...e, _label: e.title })),
    'Cuper'
  );
  timeline.setData(
    events.filter(e => e.ring === 'Kamper').map(e => ({ ...e, _label: e.title })),
    'Kamper'
  );
  timeline.setData(
    events.filter(e => e.ring === 'Annet').map(e => ({ ...e, _label: e.title })),
    'Annet'
  );

  // --- Hover Tooltip ---
  const tooltip = document.getElementById('tooltip');
  requestAnimationFrame(() => {
    document.querySelectorAll('#timeline svg path').forEach(path => {
      const label = path.__data__?._label;
      if (!label) return;

      // Native tooltip (optional)
      const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
      title.textContent = label;
      path.appendChild(title);

      // Custom styled tooltip
      path.addEventListener('mouseenter', () => {
        tooltip.textContent = label;
        tooltip.style.opacity = 1;
      });
      path.addEventListener('mousemove', e => {
        tooltip.style.left = e.clientX + 10 + 'px';
        tooltip.style.top = e.clientY + 10 + 'px';
      });
      path.addEventListener('mouseleave', () => {
        tooltip.style.opacity = 0;
      });
    });
  });

  // --- Legend ---
  const legend = document.getElementById('legend');
  [
    { name: 'Kamper', color: '#0078D4' },
    { name: 'Cuper', color: '#edbd4c' },
    { name: 'Annet', color: '#cda2de' }
  ].forEach(ring => {
    const item = document.createElement('div');
    item.className = 'legend-item';

    const color = document.createElement('div');
    color.className = 'legend-color';
    color.style.background = ring.color;

    const label = document.createElement('span');
    label.textContent = ring.name;

    item.appendChild(color);
    item.appendChild(label);
    legend.appendChild(item);
  });

  // --- Now indicator (fixed) ---
  function addOrUpdateNowIndicator() {
    const svg = document.querySelector('#timeline svg');
    if (!svg) return;

    const year = 2026;
    const now = new Date();
    if (now.getFullYear() !== year) return;

    // Prefer viewBox (most reliable), fallback to bounding box
    const vb = svg.viewBox && svg.viewBox.baseVal;
    let width, height, centerX, centerY;

    if (vb && vb.width && vb.height) {
      width = vb.width;
      height = vb.height;
      centerX = vb.x + vb.width / 2;
      centerY = vb.y + vb.height / 2;
    } else {
      const box = svg.getBBox();
      width = box.width;
      height = box.height;
      centerX = box.x + box.width / 2;
      centerY = box.y + box.height / 2;
    }

    const outerRadius = Math.min(width, height) / 2 - 10;
    const innerRadius = 70;

    // Day-of-year progress (handles leap years)
    const start = new Date(year, 0, 1);
    const end = new Date(year + 1, 0, 1);
    const progress = (now - start) / (end - start); // 0..1

    // 0 at top, clockwise
    const angle = progress * 360 - 90;

    // Remove previous indicator
    svg.querySelectorAll('.now-indicator').forEach(el => el.remove());

    // --- LINE ---
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.classList.add('now-indicator');
    line.setAttribute('x1', centerX);
    line.setAttribute('y1', centerY - innerRadius);
    line.setAttribute('x2', centerX);
    line.setAttribute('y2', centerY - outerRadius);
    line.setAttribute('stroke', '#e53935');
    line.setAttribute('stroke-width', '2');
    line.setAttribute('transform', `rotate(${angle} ${centerX} ${centerY})`);

    // --- DOT ---
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.classList.add('now-indicator');
    dot.setAttribute('cx', centerX);
    dot.setAttribute('cy', centerY - outerRadius);
    dot.setAttribute('r', '5');
    dot.setAttribute('fill', '#e53935');
    dot.style.filter = 'drop-shadow(0 0 6px #e53935)';
    dot.setAttribute('transform', `rotate(${angle} ${centerX} ${centerY})`);

    svg.appendChild(line);
    svg.appendChild(dot);

    // Update once per minute (no need for 60fps)
    setTimeout(addOrUpdateNowIndicator, 60_000);
  }

  requestAnimationFrame(addOrUpdateNowIndicator);
</script>

</body>
</html>
